# f7_udp
ROS2 ノードと NUCLEO-F767ZI をUDPで通信するパッケージです。  

## 概要 
4輪オムニ試作機向けに開発したパッケージです。キャチロボ2024でも採用、NHKロボコン2025でも使用予定です。
UDP経由でNUCLEO-F767ZI（専用プログラム書き込み必須*1）と通信しモータードライバーを駆動することができます。
Mbedのサービス終了、既存のmicroROSに劣るということもあり新環境を模索中です。  

## 実行環境 
Ubuntu 22.04 LTS  
ROS 2 Humble

## *1 Mbed側の専用プログラム 
f7_udp_mbed~系統のリポジトリがmbed側のコードになっています。

エンコーダーの読み取りに必要なQEIライブラリ（Mbed OS 6に対応するように改変）を含みます。
フィードバック制御に対応するためにエンコーダーから速度(m/s)を求め、UDPで返す機能もあります。（1番と２番のエンコーダーのみ動作確認済み）
UDPで返された速度をROS2ノードで受信＆Publishするノードについてはf7_udpパッケージ内のソースファイル、enc_obs.py を参照してください。

## 使い方
### １，マイコン側プログラムの書き込み
NUCLEO-F767ZIにプログラムを書き込む。このときコード内のIPv4アドレスを任意のものに変更する。複数のマイコンを使うときはそれぞれに異なるIPを割り当てる。IPの割り当て状況については後述。
### ２，ネットワークに接続する
マイコンとルーターをLANケーブルで接続、PCも有線or無線でルーターに接続する。（無線の場合は5GHz帯を推奨）  
### ３，ROS2側IPの割り当て
ROS2ノードのコード内、送信先IPを先程指定したものに変更する  
### ４，ROS2ノードの準備
ROS2ノードの配列"data"に各モーターの出力を格納する。配列の各要素は各モーターの出力に対応している。たとえば"data[1] = 10"と代入すれば1番のモーターが10%で回る(1番に接続されたMDにduty比10%が出力される)。逆回転にしたい場合は-10を代入すれば良い。モーター以外の駆動は後述。
### ５，Run
ビルドしてノードを走らせる。  
### ６，確認
マイコン側のLANポートのアクセスランプが点滅していれば通信は成功。  
注）動的IPに対応したノードではアクセスランプの点滅で確認することができない。

## 注意点
・ノードを走らせると大量のパケットを送信先アドレスに送りつけることになるので大学のWi-Fiなどといった公共のネットワークではオフラインモードで実行する。
・動的IPへの対応により公共ネットワークで容易に実行可能になってしまったので接続しているネットワークをよく確認してから実行する。  
・比較的新しいノードではIPアドレスの割り当てに失敗してもエラーを吐かない。（例外処理を実装しているため自動的にオフラインモードで実行される）うまく動かないときはPCがマイコンと同じネットワークに接続されていることを確認する。  


## IP割り当て状況（NHK2025）
ROS 2 ノードは動的IPに対応していますが、マイコンとのIP競合を防ぐために必ずIPを固定してください。
| IP | 機器 | 詳細 |
| ---- | ---- | ---- |
| 192.168.8.1 | ルーター | デフォルトゲートウェイ |
| 192.168.8.191 | PC | imori | 
| 192.168.8.193 | PC | ubuntu | 
| 192.168.8.195 | PC | dev | 
| 192.168.8.197 | 空き | / |  
| 192.168.8.199 | 空き | / |   
| 192.168.8.205 | ラズパイ4 | 赤 | 
| 192.168.8.215 | F767ZI | MR足回り |
| 192.168.8.216 | F767ZI | MR機構 |
| 192.168.8.217 | F767ZI | DR足回り |
| 192.168.8.218 | F767ZI | DR機構 |

## 配列要素について
現時点ではROS 2ノードからマイコンに送信される配列dataは９個の要素を持っています。追加のアクチュエータ駆動のために配列要素の拡張(9番以降)を予定しています。追加予定の要素も含めた各要素の詳細をここにまとめます。
| data[n] | 詳細 |
| ---- | ---- |
| data[0] | 未使用、送信もされないので注意 |
| data[1] | MD1 |
| data[2] | MD2 |
| data[3] | MD3 |
| data[4] | MD4 |
| data[5] | MD5 |
| data[6] | MD6 |
| data[7] | MD7（旧メイン基板のみ使用可） |
| data[8] | MD8（旧メイン基板のみ使用可） |
| data[9]| サーボ1 or 電磁弁1 |
| data[10]| サーボ2 or 電磁弁2 |
| data[11]| サーボ3 or 電磁弁3 |
| data[12]| サーボ4 or 電磁弁4 |
| data[13]| パイロットランプ1 |
| data[14]| パイロットランプ2 |
| data[15]| その他通信 |
| data[16]| その他通信 |


## 命名規則
cr24_はキャチロボ2024、NR25_はNHKロボコン2025を表しています。新しいノードを作成する際はこれらの大会向けコードを参考にしてください。

## 実績
キャチロボ2024 ２回生機体  
NHKロボコン2025　汎用機、ダンク機

## Powered by
2024年度立命館大学ロボット技術研究会NHKプロジェクト  
2024 NHK Project, RRST, Ritsumeikan University 

![Logo](https://www.rrst.jp/img/logo.png)