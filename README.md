# f7_udp
ROS2 ノードと NUCLEO-F767ZI をUDP経由で通信するパッケージです。  

## 概要 
4輪オムニ試作機向けに開発したパッケージです。キャチロボ2024でも採用、NHKロボコン2025でも使用予定です。
UDP経由でNUCLEO-F767ZI（専用プログラム書き込み必須*1）と通信しモータードライバーを駆動することができます。
Mbedのサービス終了、既存のmicroROSに劣るということもあり近いうちに新環境に移行する予定です。

## 実行環境 
Ubuntu 22.04 LTS
ROS2 Humble

## *1 Mbed側の専用プログラム 
https://github.com/KouTashi/f7_udp_mbed_fb.git

エンコーダーの読み取りに必要なQEIライブラリ（Mbed OS 6に対応するように改変）を含みます。
フィードバック制御に対応できるようにエンコーダーから速度(m/s)を求め、UDPで返す機能もあります。（1番と２番のエンコーダーのみ動作確認済み）
UDPで返された速度をROS2ノードで受信＆Publishするノードについてはf7_udpパッケージ内のソースファイル、enc_obs.py を参照してください。

## 使い方
１，NUCLEO-F767ZIにプログラムを書き込む。このときコード内のIPv4アドレスを任意のものに変更する。複数のマイコンを使うときはそれぞれに異なるIPを割り当てる。  
２，マイコンとルーターをLANケーブルで接続、PCも有線、または無線でネットワークに接続する。（無線の場合は5GHz帯を推奨）  
３，ROS2ノードのコード内、送信先IPを先程指定したものに変更する  
４，ROS2ノードの配列"data"に各モーターの出力を格納する。配列の各要素は各モーターの出力に対応している。たとえば"data[1] = 10"と指定すれば1番のモーターが10%で回る。  
５，ビルドしてしてノードを走らせる。  
６，マイコン側のLANポートのアクセスランプが点滅していれば通信自体は成功。  

## 注意点
・ノードを走らせると大量のパケットを送信先アドレスに送りつけることになるので大学のWi-Fiなどといった公共のネットワークで実行しないようにする。  
・比較的新しいノードではIPアドレスの割り当てに失敗してもエラーを吐かない。（デバッグのために例外処理を実装しているため）うまく動かないときはPCがマイコンと同じネットワークに接続されていることを確認する。　　
## 実績
キャチロボ2024 ２回生機体
NHKロボコン2025　汎用機、ダンク機

## Powered by
2024年度立命館大学ロボット技術研究会NHKプロジェクト  
2024 NHK Project, RRST, Ritsumeikan University 

![Logo](https://www.rrst.jp/img/logo.png)