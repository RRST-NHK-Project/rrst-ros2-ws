## f7_udp_cpp
ROS 2-マイコン間の通信をUDPで行うパッケージです。NHK学生ロボコン2025で使用予定。マイコンはNUCLEO-F767ZIを採用。すべての機能を使うにはメイン基板（V1.3以降）が必要です。

## 実行環境 
| OS | ROS | 
| ---- | ---- | 
| Ubuntu 24.04 LTS | Jazzy | 

## マイコン側のプログラム 
ros2_udp_pioリポジトリがマイコン側のプログラム群です。

## 使い方
### １，マイコン側プログラムの書き込み
NUCLEO-F767ZIにプログラムを書き込む。このときコード内のIPv4アドレスを任意のものに変更する。複数のマイコンを使うときはそれぞれに異なるIPを割り当てる。IPの割り当て状況については後述。
### ２，ネットワークに接続する
マイコンとルーターをLANケーブルで接続、PCも有線or無線でルーターに接続する。（無線の場合は5GHz帯を推奨）  
### ３，ROS2側IPの割り当て
ROS2ノードのコード内、送信先IPを先程指定したものに変更する  
### ４，ROS2ノードの準備
ROS2ノードの配列"data"の各要素は各アクチュエータの出力に対応している。たとえば"data[1] = 10"と代入すれば1番のモーターが10%で回る(1番に接続されたMDにduty比10%が出力される)。逆回転にしたい場合は-10を代入すれば良い。モーター以外にもPWMサーボ、ソレノイドバルブ（電磁弁）、パイロットランプなどの駆動ができる。また、マイコン側でエンコーダーの値を取得しROS 2で受信することもできる。
### ５，Run
ビルドしてノードを走らせる。  
### ６，確認
マイコン側のLANポートのアクセスランプが点滅していれば通信は成功。  

## 諸注意
・接続しているネットワークをよく確認してから実行する。当然、マイコンと同じネットワークに接続しないと動かない。  
・ビルド中にフリーズしてしまうときはスワップ領域を追加する。


## IP割り当て状況（NHK2025）
動的IPに対応していますが、マイコンとのIP競合を防ぐために必ずIPを固定してください。
| IP | 機器 | 詳細 |
| ---- | ---- | ---- |
| 192.168.8.1 | ルーター | デフォルトゲートウェイ |
| 192.168.8.191 | PC | imori | 
| 192.168.8.193 | PC | ubuntu | 
| 192.168.8.195 | PC | dev | 
| 192.168.8.197 | 空き | / |  
| 192.168.8.199 | 空き | / |   
| 192.168.8.205 | ラズパイ4 | 赤 | 
| 192.168.8.215 | F767ZI | MR足回り |
| 192.168.8.216 | F767ZI | MR機構 |
| 192.168.8.217 | F767ZI | DR足回り |
| 192.168.8.218 | F767ZI | DR機構 |

## 配列要素　（メイン基板V1.3以降）
ROS 2ノードからマイコンに送信される配列'data'は19個の要素を持っています。各要素の詳細をここにまとめます。  
debug: マイコンのprintfを有効化, MD: モータードライバー, TR: トランジスタ
| data[n] | 詳細 | 範囲 |
| ---- | ---- | ---- |
| data[0] | debug | 0 or 1 |
| data[1] | MD1 | -100 ~ 100 |
| data[2] | MD2 | -100 ~ 100 |
| data[3] | MD3 | -100 ~ 100 |
| data[4] | MD4 | -100 ~ 100 |
| data[5] | MD5 | -100 ~ 100 |
| data[6] | MD6 | -100 ~ 100 |
| data[7] | Servo1 | 0 ~ 270 |
| data[8] | Servo2 | 0 ~ 270 |
| data[9] | Servo3 | 0 ~ 270 |
| data[10] | Servo4 | 0 ~ 270 |
| data[11] | TR1 | 0 or 1|
| data[12] | TR2 | 0 or 1|
| data[13] | TR3 | 0 or 1|
| data[14] | TR4 | 0 or 1|
| data[15] | TR5 | 0 or 1|
| data[16] | TR6 | 0 or 1|
| data[17] | TR7 | 0 or 1|
| data[18] | TR8 | 0 or 1|



## 命名規則
NR25_はNHKロボコン2025を表しています。新しいノードを作成する際はこれらの大会向けコードを参考にしてください。

## 実績

## Powered by
2024年度立命館大学ロボット技術研究会NHKプロジェクト  
2024 NHK Project, RRST, Ritsumeikan University 

![Logo](https://www.rrst.jp/img/logo.png)
